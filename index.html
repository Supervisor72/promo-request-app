<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Richiesta Sconto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 15px;
      box-sizing: border-box;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
      margin-bottom: 6px;
    }
    select, input[type="text"], input[type="number"], input[type="date"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 25px;
      justify-content: center;
    }
    button, input[type="submit"] {
      background-color: #007bff;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      flex: 1 1 45%;
      min-width: 140px;
      transition: background-color 0.3s ease;
    }
    button:hover, input[type="submit"]:hover {
      background-color: #0056b3;
    }
    #errorSconto {
      color: red;
      font-size: 14px;
      margin-top: 6px;
      display: none;
    }
    @media (max-width: 480px) {
      button, input[type="submit"] {
        flex: 1 1 100%;
      }
    }
  </style>
  <script>
    function aggiornaMailto(form) {
      const pv = form["Punto Vendita"].value;
      const prod = form["Prodotto"].value;
      const codProd = form["Codice Prodotto"].value;
      const cliente = form["Cognome Nome Cliente"].value;
      const data = form["Data Vendita"].value;
      const prezzoPart = form["Prezzo Partenza"].value;
      const prezzoScont = form["Prezzo Scontato"].value;
      const scontoRichiesto = form["Sconto Richiesto"].value;

      const body = 
        `Punto Vendita: ${pv}\n` +
        `Prodotto: ${prod}\n` +
        `Codice Prodotto: ${codProd}\n` +
        `Cliente: ${cliente}\n` +
        `Data Vendita: ${data}\n` +
        `Prezzo Partenza: €${prezzoPart}\n` +
        `Prezzo Scontato: €${prezzoScont}\n` +
        `Sconto Richiesto: ${scontoRichiesto}%\n\n` +
        `Autorizzi Sconto: (Rispondere con "SI" o "NO")`;

      const mailtoLink = `mailto:d.pavoni@dml-italia.com?subject=Richiesta sconto da ${encodeURIComponent(pv)}&body=${encodeURIComponent(body)}`;
      form.action = mailtoLink;
    }

    function verificaSconto() {
      const prod = document.getElementById("prodotto").value;
      const sconto = parseFloat(document.getElementById("sconto").value);
      const errorEl = document.getElementById("errorSconto");

      if (!prod || isNaN(sconto)) {
        errorEl.style.display = "none";
        return true;
      }
      
      if (prod === "TV" && sconto > 5) {
        errorEl.textContent = "Per il prodotto TV lo sconto massimo consentito è il 5%.";
        errorEl.style.display = "block";
        return false;
      }
      if (prod === "BIANCO" && sconto > 10) {
        errorEl.textContent = "Per il prodotto BIANCO lo sconto massimo consentito è il 10%.";
        errorEl.style.display = "block";
        return false;
      }

      errorEl.style.display = "none";
      return true;
    }

    function aggiornaScontoMassimo() {
      const prod = document.getElementById("prodotto").value;
      const scontoInput = document.getElementById("sconto");
      if (prod === "TV") {
        scontoInput.max = "5";
      } else if (prod === "BIANCO") {
        scontoInput.max = "10";
      } else {
        scontoInput.removeAttribute("max");
      }
    }

    function preparaTelegram() {
      const pv = document.querySelector('select[name="Punto Vendita"]').value;
      const prod = document.querySelector('select[name="Prodotto"]').value;
      const codProd = document.querySelector('input[name="Codice Prodotto"]').value;
      const cliente = document.querySelector('input[name="Cognome Nome Cliente"]').value;
      const data = document.querySelector('input[name="Data Vendita"]').value;
      const prezzoPart = document.querySelector('input[name="Prezzo Partenza"]').value;
      const prezzoScont = document.querySelector('input[name="Prezzo Scontato"]').value;
      const scontoRichiesto = document.querySelector('input[name="Sconto Richiesto"]').value;

      if (!pv || !prod || !codProd || !cliente || !data || !prezzoPart || !prezzoScont || !scontoRichiesto) {
        alert("Compila tutti i campi prima di preparare il messaggio Telegram.");
        return;
      }

      const message = 
        `Punto Vendita: ${pv}\n` +
        `Prodotto: ${prod}\n` +
        `Codice Prodotto: ${codProd}\n` +
        `Cliente: ${cliente}\n` +
        `Data Vendita: ${data}\n` +
        `Prezzo Partenza: €${prezzoPart}\n` +
        `Prezzo Scontato: €${prezzoScont}\n` +
        `Sconto Richiesto: ${scontoRichiesto}%\n\n` +
        `Autorizzi Sconto: (Rispondere con "SI" o "NO")`;

      const telegramUrl = `https://t.me/share/url?url=&text=${encodeURIComponent(message)}`;
      window.open(telegramUrl, '_blank');
    }
  </script>
</head>
<body>
  <h1>Modulo Richiesta Sconto</h1>
  <form method="post" onsubmit="if(verificaSconto()){aggiornaMailto(this);return true;} else return false;">
    <label for="pv">Punto Vendita:</label>
    <select id="pv" name="Punto Vendita" required>
      <option value="">-- Seleziona punto vendita --</option>
      <option value="Fano">Fano</option>
      <option value="Monsano">Monsano</option>
      <option value="Osimo">Osimo</option>
      <option value="Macerata">Macerata</option>
      <option value="Civitanova">Civitanova</option>
      <option value="Pesaro">Pesaro</option>
    </select>

    <label for="prodotto">Prodotto:</label>
    <select id="prodotto" name="Prodotto" required onchange="aggiornaScontoMassimo()">
      <option value="">-- Seleziona prodotto --</option>
      <option value="TV">TV</option>
      <option value="BIANCO">BIANCO</option>
    </select>

    <label for="codice">Codice Prodotto:</label>
    <input type="text" id="codice" name="Codice Prodotto" required />

    <label for="cliente">Cognome Nome Cliente:</label>
    <input type="text" id="cliente" name="Cognome Nome Cliente" required />

    <label for="data">Data Vendita:</label>
    <input type="date" id="data" name="Data Vendita" required />

    <label for="prezzoPartenza">Prezzo Partenza (€):</label>
    <input type="number" step="0.01" id="prezzoPartenza" name="Prezzo Partenza" required />

    <label for="prezzoScontato">Prezzo Scontato (€):</label>
    <input type="number" step="0.01" id="prezzoScontato" name="Prezzo Scontato" required />

    <label for="sconto">Sconto Richiesto (%): <span id="scontoMax"></span></label>
    <input type="number" id="sconto" name="Sconto Richiesto" min="0" max="100" required oninput="verificaSconto()" />

    <div id="errorSconto"></div>

    <div class="buttons">
      <input type="submit" value="Invia Richiesta via Mail" />
      <button type="button" onclick="preparaTelegram()">Prepara Messaggio Telegram</button>
    </div>
  </form>
</body>
</html>
